@page
@model ValidationDashboardModel
@{
    ViewData["Title"] = "AI Валидация документов и назначений";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container mt-4">
    <h2 class="mb-4">@ViewData["Title"]</h2>

    <div class="row">
        <!-- ======================== TEXT VALIDATION ======================== -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    Проверка назначения платежа
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Текст назначения:</label>
                        <textarea id="purposeText" class="form-control" rows="4" placeholder="Введите назначение"></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success" onclick="checkPurpose('ProductPurpose')">Проверить (товары)</button>
                        <button class="btn btn-outline-info" onclick="checkPurpose('ServicePurpose')">Проверить (услуги)</button>
                    </div>
                    <div class="mt-3">
                        <h6>Результат:</h6>
                        <pre id="purposeResult" class="bg-light p-2"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================== FILE VALIDATION ======================== -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    Проверка документа (PDF, JPG, PNG)
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Файл документа:</label>
                        <input type="file" id="fileInput" class="form-control" accept=".pdf,.jpg,.jpeg,.png" />
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="checkDocument('Invoice')">Проверить как Инвойс</button>
                        <button class="btn btn-outline-warning" onclick="checkDocument('Contract')">Проверить как Контракт</button>
                    </div>
                    <div class="mt-3">
                        <h6>Результат:</h6>
                        <pre id="fileResult" class="bg-light p-2"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function checkPurpose(type) {
        const text = document.getElementById('purposeText').value.trim();
        const result = document.getElementById('purposeResult');
        result.textContent = '⏳ Проверка...';

        if (!text) {
            result.textContent = 'Введите текст назначения';
            return;
        }

        try {
            const response = await fetch(`/api/Validation/${type}?purpose=${encodeURIComponent(text)}`, {
                method: 'POST'
            });

            if (!response.ok) {
                result.textContent = `Ошибка: ${response.status}`;
                return;
            }

            const json = await response.json();
            result.textContent = JSON.stringify(json, null, 2);
        } catch (e) {
            result.textContent = `Ошибка: ${e.message}`;
        }
    }

    async function checkDocument(type) {
        const fileInput = document.getElementById('fileInput');
        const result = document.getElementById('fileResult');
        result.textContent = '⏳ Проверка...';

        if (!fileInput.files.length) {
            result.textContent = 'Выберите файл для загрузки';
            return;
        }

        const formData = new FormData();
        formData.append('File', fileInput.files[0]);
        formData.append('Prompt', ''); // при необходимости можно добавить свой промпт

        try {
            const response = await fetch(`/api/Validation/${type}`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                result.textContent = `Ошибка: ${response.status}`;
                return;
            }

            const json = await response.json();
            result.textContent = JSON.stringify(json, null, 2);
        } catch (e) {
            result.textContent = `Ошибка: ${e.message}`;
        }
    }
</script>
