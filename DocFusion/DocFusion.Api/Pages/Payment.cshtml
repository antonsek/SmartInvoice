@page
@model DocFusion.Web.Pages.Payment
@{
  ViewData["Title"] = "–í–∞–ª—é—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –ò–ò";
}

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<div class="max-w-5xl mx-auto bg-white shadow-md rounded-lg mt-8 p-6">
  <header class="border-b pb-4 mb-6">
    <h1 class="text-xl font-semibold text-gray-800">–í–∞–ª—é—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥</h1>
    <p class="text-sm text-gray-500">
      –ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞: <span class="font-medium text-gray-700">@Model.DocumentNumber</span> |
      –î–∞—Ç–∞ –≤–∞–ª—é—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: <span>@Model.ValuationDate:dd.MM.yyyy</span>
    </p>
  </header>

  <form id="transferForm" class="space-y-6" enctype="multipart/form-data">
    <!-- –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å -->
    <section>
      <h2 class="text-lg font-medium text-gray-700 mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">ID/NIK (–µ—Å–ª–∏ –∏–º–µ–µ—Ç—Å—è)</label>
          <input class="w-full border border-gray-300 rounded-md p-2" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ NIK">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">–í–∞–ª—é—Ç–∞</label>
          <select id="currency" class="w-full border border-gray-300 rounded-md p-2">
            <option>USD</option><option>EUR</option><option>KZT</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">–°—á–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è</label>
          <input class="w-full border border-gray-300 rounded-md p-2" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">–°—É–º–º–∞</label>
          <input type="number" class="w-full border border-gray-300 rounded-md p-2" placeholder="0.00">
        </div>
        <div class="col-span-2">
          <label class="block text-sm text-gray-600 mb-1">–ö–æ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ (KNP)</label>
          <select id="knp" class="border border-gray-300 rounded-md p-2 w-full">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–¥ KNP</option>
            <option value="701">701 ‚Äî –û–ø–ª–∞—Ç–∞ –∑–∞ —Ç–æ–≤–∞—Ä—ã</option>
            <option value="801">801 ‚Äî –û–ø–ª–∞—Ç–∞ –∑–∞ —É—Å–ª—É–≥–∏</option>
          </select>
        </div>
      </div>
    </section>

    <!-- –ü–æ–ª—É—á–∞—Ç–µ–ª—å -->
    <section>
      <h2 class="text-lg font-medium text-gray-700 mb-4">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</h2>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm text-gray-600 mb-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label><input class="w-full border border-gray-300 rounded-md p-2"></div>
        <div><label class="block text-sm text-gray-600 mb-1">–°—á–µ—Ç</label><input class="w-full border border-gray-300 rounded-md p-2"></div>
      </div>
    </section>

    <!-- –ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è -->
    <section>
      <h2 class="text-lg font-medium text-gray-700 mb-4">–ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</h2>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm text-gray-600 mb-1">SWIFT</label><input class="w-full border border-gray-300 rounded-md p-2" placeholder="OCRNAU2JXXX"></div>
        <div><label class="block text-sm text-gray-600 mb-1">–ë–∞–Ω–∫</label><input class="w-full border border-gray-300 rounded-md p-2"></div>
      </div>
      <div class="mt-4">
        <label class="block text-sm text-gray-600 mb-1">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</label>
        <textarea id="purpose" class="w-full border border-gray-300 rounded-md p-2 transition duration-200" rows="3"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞..."></textarea>
      </div>

      <div class="mt-4">
        <label class="block text-sm text-gray-600 mb-1">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç (–∏–Ω–≤–æ–π—Å)</label>
        <input id="file" type="file" class="w-full border border-gray-300 rounded-md p-2 bg-gray-50">
      </div>
    </section>

    <div class="flex justify-end mt-6 items-center gap-3">
      <button type="button" id="btnCheck" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ò–ò
      </button>
      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md shadow">–î–∞–ª–µ–µ</button>
    </div>
  </form>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div id="ai-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
    <div class="p-4 border-b flex justify-between items-center">
      <h3 class="font-semibold">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ò–ò</h3>
      <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
    </div>
    <div id="ai-modal-body" class="p-4 text-sm text-gray-800"></div>
    <div class="p-4 border-t flex justify-end">
      <button onclick="closeModal()" class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
  async function checkPurpose() {
    const btn = document.getElementById('btnCheck');
    const file = document.getElementById('file').files[0];
    const purpose = document.getElementById('purpose').value.trim();
    const knp = parseInt(document.getElementById('knp').value || 0);

    if (!purpose) return showModal('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞.');
    if (!file) return showModal('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–Ω–≤–æ–π—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.');

    btn.disabled = true;
    const originalText = btn.textContent;
    btn.innerHTML = 'üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞...';

    let endpointPurpose = '/api/Validation/ServicePurpose';
    if (knp >= 700 && knp < 800) endpointPurpose = '/api/Validation/ProductPurpose';

    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Ç–µ–∫—Å—Ç –∏ –¥–æ–∫—É–º–µ–Ω—Ç
      const formData = new FormData();
      formData.append('File', file);

      const [textResp, docResp] = await Promise.all([
        fetch(endpointPurpose + '?purpose=' + encodeURIComponent(purpose), { method: 'POST' }),
        fetch('/api/Validation/Invoice', { method: 'POST', body: formData })
      ]);

      const results = [];
      let allPassed = true;

      // –¢–µ–∫—Å—Ç
      if (textResp.ok) {
        const textData = await textResp.json();
        const prob = textData.probability ?? 0;
        const ok = prob >= 80;
        results.push({
          name: '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞',
          ok,
          detail: ok
            ? `–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ (${prob}%)`
            : `–ù—É–∂–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–∞ (${prob}%)`
        });
        if (!ok) allPassed = false;
      } else {
        results.push({ name: '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞', ok: false, detail: '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞' });
        allPassed = false;
      }

      // –î–æ–∫—É–º–µ–Ω—Ç
      if (docResp.ok) {
        const docData = await docResp.json();
        const prob = docData.probability ?? 0;
        const ok = prob >= 85;
        results.push({
          name: '–ò–Ω–≤–æ–π—Å',
          ok,
          detail: ok
            ? `–†–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (${prob}%)`
            : `–ù–µ—É–≤–µ—Ä–µ–Ω–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω (${prob}%). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–∞.`
        });
        if (!ok) allPassed = false;
      } else {
        results.push({ name: '–ò–Ω–≤–æ–π—Å', ok: false, detail: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç.' });
        allPassed = false;
      }

      // üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏
      const tips = [];
      if (results.find(r => r.name === '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞' && !r.ok)) {
        tips.push('–£—Ç–æ—á–Ω–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä –∏ –¥–∞—Ç—É –∏–Ω–≤–æ–π—Å–∞ –∏–ª–∏ –¥–æ–≥–æ–≤–æ—Ä–∞.');
        tips.push('–û–ø–∏—à–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –ø–ª–∞—Ç–µ–∂–∞ (—Ç–æ–≤–∞—Ä—ã, —É—Å–ª—É–≥–∏, –∞—Ä–µ–Ω–¥–∞ –∏ —Ç.–ø.).');
        tips.push('–î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞, –µ—Å–ª–∏ —ç—Ç–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥.');
      }
      if (results.find(r => r.name === '–ò–Ω–≤–æ–π—Å' && !r.ok)) {
        tips.push('–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω–≤–æ–π—Å —á–∏—Ç–∞–µ–º –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–º–µ—Ä, –¥–∞—Ç—É –∏ —Å—É–º–º—É.');
        tips.push('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–ø–∏—Å–∏ –∏ –ø–µ—á–∞—Ç–∏ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è).');
        tips.push('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ PDF –∏–ª–∏ DOCX, –∞ –Ω–µ —Å–∫–∞–Ω –≤ –Ω–∏–∑–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ.');
      }

      // HTML
      let html = `<p class='font-medium mb-3'>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:</p><ul class='space-y-2'>`;
      for (const r of results) {
        html += `<li class='flex items-center gap-2'>
                        <span>${r.ok ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <span><strong>${r.name}</strong> ‚Äî ${r.detail}</span>
                    </li>`;
      }
      html += `</ul>`;

      if (tips.length > 0) {
        html += `<div class='mt-4'>
                        <p class='font-medium mb-2'>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</p>
                        <ul class='list-disc ml-5 text-gray-700 space-y-1'>
                            ${tips.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    </div>`;
      } else {
        html += `<p class='mt-3 text-green-600 font-medium'>‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥.</p>`;
      }

      showModal(html);

    } catch (err) {
      showModal(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }

  function showModal(html) {
    const modal = document.getElementById('ai-modal');
    document.getElementById('ai-modal-body').innerHTML = html;
    modal.classList.remove('hidden');
  }
  function closeModal() {
    document.getElementById('ai-modal').classList.add('hidden');
  }
  document.getElementById('btnCheck').addEventListener('click', checkPurpose);
</script>
